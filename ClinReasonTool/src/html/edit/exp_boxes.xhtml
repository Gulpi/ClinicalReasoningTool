<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"   
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:v="urn:schemas-microsoft-com:vml">
 <f:view locale="#{adminContext.locale}">     

<head>
<f:event type="preRenderView" listener="#{facesContext.externalContext.response.setHeader('Cache-Control', 'no-cache, no-store')}" />

<title>Patient Illness Script</title>
 <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/>
<link rel="stylesheet" type="text/css" href="../../scripts/jquery112/ui-lightness/jquery-ui.css" /> 
<link rel="stylesheet" type="text/css" href="../../styles/jsPlumbToolkit-defaults.css" />
<link rel="stylesheet" href="../../styles/clinreason_boxes.css" />
<link rel="stylesheet" href="../../styles/font-awesome/css/font-awesome.css" />

<script type="text/javascript" src="../../scripts/jquery112/jquery.js"></script>
<script type="text/javascript" src="../../scripts/jquery112/jquery-ui.min.js"></script>
<script type="text/javascript" src="../../scripts/jquery112/jquery-ui.js"></script>

<script src="../../scripts/connection.js"></script>
<script src="../../scripts/list.js"></script>

<script src="../../scripts/crt_box.js"></script>
<script src="../../scripts/ajax.js"></script>
<script src="../../scripts/jsplumb/jsPlumb.min.js"></script>
<script src="../../scripts/myjsplumb.js"></script>
<script src="../../scripts/editexp.js"></script>
 
<script language="JavaScript">

var hideCnxTitle = "#{prop['cnx.hide']}";
var showCnxTitle = "#{prop['cnx.show']}";
var submitDialogTitle = "#{prop['submit.dialog.title']}";
var chgCnxDialogTitle = "#{prop['cnx.dialog.title']}";

var msg2="Please connect the hypotheses with the findings";
var scriptId = "#{adminContext.patillscript.id}";
var listUrl="../jsonp_#{adminContext.patillscript.locale}.json";
var scriptlang = "#{adminContext.patillscript.locale}";
if(scriptlang=="de") listUrl = "../jsonp_de.json";
var lang="#{adminContext.locale}";
var currentStage = #{adminContext.patillscript.stage};
var currentStageScript = "#{adminContext.patillscript.currentStageWithUpdate}";
var active;
var instance;
var item_arr = new Array();
var exp_arr = new Array();

$(function() {
	if(scriptlang=="de") listUrl = "../jsonp_de.json";
	$(".listdialog").hide();
	//$("#jdialogError").hide();
	$("#connContext").hide();
	$("#summStText").on('change',function(){
		saveSummSt('#{adminContext.patillscript.summStId}');
	 });
	$(".chgstage").on('change',function(){
		chgStageItem(this);
	 });

	$("#jdialog").dialog({
		autoOpen: false,
		modal: true,
		width: "auto",
		height: "auto"
	});
	
	$("#connContext").dialog({
		autoOpen: false,
		modal: true,
		width: "auto",
		height: "auto"
	});
	
	$( this ).tooltip({
      	items: "[mytooltip]",
      	position: { my: "left+5 center", at: "right center" },
      	content: function() {
        var element = $( this );
		return $( this ).attr( "mytooltip" );
		}
    });
});


jsPlumb.ready(function () {

     	instance = jsPlumb.getInstance({
        DragOptions: { cursor: 'pointer', zIndex: 2000 },
        PaintStyle: { strokeStyle: '#666' },
        EndpointHoverStyle: { fillStyle: "orange" },
        HoverPaintStyle: { strokeStyle: "orange" },
        EndpointStyle: { width: 25, height: 15, strokeStyle: '#666' },
        Endpoint: "Rectangle",
        Anchors: ["TopCenter", "TopCenter"],
        Container: "canvas"
    });

    // suspend drawing and initialise.
    instance.batch(function () {

        instance.bind("click", function (component, originalEvent) {
        	//todo: ignore expert cnxs....
        	var id = component.id;
        	if(!id.startsWith("exp_")) 
        		openConnContext(component.id);
        });

        instance.draggable(jsPlumb.getSelector(".drag-drop .itembox"));        
    	//item was moved -> trigger ajax call to update position
        $( ".drag-drop .itembox" ).draggable({
        	  stop: function( event, ui ) {
        		  handleRectDrop(ui);
        	  }
        });
       
        initGroups(instance);
       
    });
    // collapse/expand group button
    instance.on(canvas, "click", ".node-collapse", function() {
    	toggleContainerCollapse(this.parentNode);
    });
    $(".itembox").contextmenu(function(event) {
    	  //alert( "Handler for .contextmenu() called." );
    	  showDropDown("dd"+this.id);
    	  event.preventDefault();
   	 });
    
    initConnections();
    initCnxDisplay();
    $(".jsplumb-connector").attr("title","Click to change or delete");
    //registers a connection that is made: this code needs to be AFTER the init has happened, otherwise each init 
    //event triggers this. 
    instance.bind("connection", function (info, originalEvent){
    	if (!isDuplicateCnx(info, "#{prop['cnx.duplicate']}"))
    		addConnection(info);
    });
    $(".expbox").addClass("expboxstatus");
    jsPlumb.fire("jsPlumbDemoLoaded", instance);
    
    initBoxHeights();
    initContainerCollapsed();
	
});

var item_arr = new Array();
var ajaxUrl = "/crt/src/html/edit/tabs_ajax.xhtml";

</script>
</head>
<body style="font-family:arial;" data-demo-id="draggableConnectors" data-library="dom">
<div>
ScriptId:  #{adminContext.patillscript.id}<br/>
VPId: <input type="text" value="#{adminContext.patillscript.vpId}"></input><br/>
System <select name="system"><option value="">Casus (uni)</option></select><br/>
Stage: <span id="stageSpan">#{adminContext.patillscript.stage} </span>
<a href="javascript:chgStage(-1,'exp_boxes.xhtml');">previous stage</a> <a href="javascript:chgStage(1,'exp_boxes.xhtml');">next stage</a>

</div>

<div class="options">
	<a href="javascript:toogleCnxDisplay();" id="cnxtoggle" title="Hide connections"><i id="cnxtogglei" class="fa fa-conn_on"></i></a>
	<!--  <a href="exp_stages.xhtml" target="new">exp dev</a>-->
	<!--  <a href="alert('not yet available, will show the development of the experts script during the case');">exp dev</a>-->
</div>
<div class="boxes_container" style="float:left;width:60%;">
	<div id="canvas" class="canvas jtk-surface drag-drop jtk-surface-nopan" >
		  <!-- problems -->
		  <div id="fdg_box"  class="container expcontainer" group="fdg_group">
		   		<div class="title">#{prop['findings']}  
		   		</div>
		   		<div class="node-collapse"></div>
		  			<div class="search boxchild"><span class="icon"><i class="icon-search"></i></span>
		  			<input type="text" id="fdg_prefix" style="display:none;" />
		  			
		  			<!-- <select class="f_select" style="width:40px;" id="fdg_prefix"><option value="0">-</option><option value="1">No</option></select>-->
		  			<input class="f_text" style="width:155px;" id="problems" placeholder="Search..." title="Please add any problems, findings, exposures, or risk factors you consider as relevant"></input></div>
						<h:form id="probform">
						<h:panelGroup>
						   <ui:repeat id="repeatprob" value="#{adminContext.patillscript.problemsStage}" var="prob" varStatus="status">
						   		<ui:include src="../probbox.xhtml" />
	    					</ui:repeat>	    						    					
	    				</h:panelGroup>
    				     <h:commandButton id="hiddenProbButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateItemCallback"></f:ajax>
						</h:commandButton>
						
						<!-- <h:messages errorClass="errorMessage" infoClass="infoMessage" showDetail="true" showSummary="true"/>-->						
						</h:form>
						<span class="errormsg" id="msg_probform"></span>
		  </div>
		  <!--  diagnoses -->
		  <div id="ddx_box" class="container expcontainer" group="ddx_group">	
		  		<div class="title">#{prop['ddx']}
		  		</div>	
		  		<div class="node-collapse"></div>	  		
		  			<div class="search boxchild"><input class="f_text" id="ddx" title="Please add your differentials"></input></div>
			  			<h:form id="ddxform">
						<h:panelGroup >
							<ui:repeat value="#{adminContext.patillscript.diagnosesStage}" var="ddx" varStatus="status">
								<ui:include src="../ddxbox.xhtml" />
	     					</ui:repeat>					
	    				</h:panelGroup>
	    				     <h:commandButton id="hiddenDDXButton" value="RenderSomething" style="visibility:hidden">
	    						<f:ajax render="@form" onevent="updateDDXCallback"></f:ajax>
							</h:commandButton></h:form>
					<span class="errormsg" id="msg_ddxform"></span>							
		  </div><br/>
		  <!-- tests -->
		  <div id="tst_box" class="container expcontainer" group="tst_group">
		  		<div class="title">#{prop['tests']}
		  		</div>
		 	 	<div class="node-collapse"></div>
		  		<div class="search boxchild"><input class="f_text" id="tests" title="Please add any tests or examinations you want to order or perform."></input></div>
		  			<h:form id="testform">
		  			<h:panelGroup>
					
						<ui:repeat value="#{adminContext.patillscript.testsStage}" var="test" varStatus="status">
							<ui:include src="../testbox.xhtml" />
     					</ui:repeat>				
    				</h:panelGroup>
    				     <h:commandButton id="hiddenTestButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateTestCallback"></f:ajax>
						</h:commandButton>
					</h:form>
					<span class="errormsg" id="msg_testform"></span>
		</div>
		  <!-- managements -->
		  <div id="mng_box" class="container expcontainer" group="mng_group">
		  	<div class="title">#{prop['mng']}
		  	</div>
		 	 <div class="node-collapse"></div>
		  	<div class="search boxchild"><input class="f_text" id="mng" title="Please add any management decisions for your patient."></input></div>
	  			<h:form id="mngform">
	  			<h:panelGroup>
	
					<ui:repeat value="#{adminContext.patillscript.mngsStage}" var="mng" varStatus="status">
						<ui:include src="../mngbox.xhtml" />
	   				</ui:repeat>				
	  				</h:panelGroup>
	  				     <h:commandButton id="hiddenMngButton" value="RenderSomething" style="visibility:hidden">
	  						<f:ajax render="@form" onevent="updatMngCallback"></f:ajax>
					</h:commandButton>
				</h:form>
				<span class="errormsg" id="msg_mngform"></span>
				
	  		</div>
	  		<div id="sum_box" class="container sum_container" group="sum_group">	
		 	<div class="title">#{prop['summst']}
		 	</div>
		 	 <div class="node-collapse"></div>
		 	 <textarea style="display:none;" id="summStTextHidden" cols="65" rows="3">#{adminContext.patillscript.summSt.text}</textarea>
				<textarea class="f_textarea boxchild" name="summSt" id="summStText" cols="65" rows="3">#{adminContext.patillscript.summStStage.text}</textarea><br/>
			 	<span class="errormsg" id="msg_sumstform"></span>
		</div>
	</div>
</div>
<div id="jsonConns" style="display:none;">#{adminContext.graph.jsonConns}</div> 

<div id="connContext">
	<ui:include src="../cnxchange.xhtml" />
</div>

<div id="allitems" style="float:right;width:30%;">
	<ui:repeat value="#{adminContext.graph.allVertices}" var="nodes" varStatus="status">
		<ui:include src="items_exp.xhtml" />
	</ui:repeat>				
</div>
</body>
</f:view>
</html>