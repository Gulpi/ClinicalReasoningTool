<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"   
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      >
<!-- <html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"      
      xmlns:h="http://java.sun.com/jsf/html">-->
<head>

<title>Patient Illness Script</title>
 <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

<link rel="stylesheet" type="text/css" href="../scripts/jquery112/ui-lightness/jquery-ui.css" /> 
<link rel="stylesheet" type="text/css" href="../scripts/draw2d/css/contextmenu.css"  />
<!--  <link rel="stylesheet" type="text/css" href="<PMW fcache>files/html/scripts/draw2d/css/contextmenu.css"  />-->
<link rel="stylesheet" href="../styles/clinreason.css" />

<script type="text/javascript" src="../scripts/jquery112/jquery.js"></script>
<script type="text/javascript" src="../scripts/jquery112/jquery-ui.min.js"></script>
<script type="text/javascript" src="../scripts/jquery112/jquery-ui.js"></script>
<script src="../scripts/draw2d/lib/shifty.js"></script>	
<script src="../scripts/draw2d/lib/raphael.js"></script>			
<script src="../scripts/draw2d/lib/jquery.autoresize.js"></script>	
<script src="../scripts/draw2d/lib/jquery-touch_punch.js"></script>	
<script src="../scripts/draw2d/lib/jquery.contextmenu.js"></script>	
<script src="../scripts/draw2d/lib/rgbcolor.js"></script>	
<script src="../scripts/draw2d/lib/canvg.js"></script>	
<script src="../scripts/draw2d/lib/Class.js"></script>	
<script src="../scripts/draw2d/lib/json2.js"></script>	


<script src="../scripts/draw2d/lib/pathfinding-browser.min.js"></script>
<script src="../scripts/draw2d/src/draw2d.js"></script>	
<script src="../scripts/draw2d/src/LabelConnection.js"></script>	
<script src="../scripts/draw2d/src/LabelRectangle.js"></script>	
<script src="../scripts/draw2d/src/LabelLMEditor.js"></script>	
<script src="../scripts/draw2d/src/MyCanvas.js"></script>	
<script src="../scripts/draw2d/lib/jquery.browser.js"></script>
<script src="../scripts/draw2d/lib/jquery.layout.js"></script>
<script src="../scripts/mydraw2d.js"></script>
<script src="../scripts/crt.js"></script>
<script src="../scripts/ajax.js"></script>

<script language="JavaScript">


var msg2="Please connect the hypotheses with the findings";
var numHyps = 1;
var numFinds = 0;
var numDiagnSteps = 0;
var numMng = 0;
var sessId = "#{crtContext.patillscript.sessionId}";
var scriptId = "#{crtContext.patillscript.id}";
var jsonConnsMap = '#{crtContext.patillscript.connsJson}';  //connections for concept map 

var my_canvas = null;

 draw2d.Configuration.factory.createConnection=function(sourcePort, targetPort, callback, dropTarget){
	 addConnection(sourcePort, targetPort);
	 return new LabelConnection();
 };
 

$(function() {
	$("#dialogCMDDX").hide();
	$("#dialogCMProb").hide();
	$("#dialogCMTest").hide();
	$("#dialogCMMng").hide();

	//$("#dialogCMNewProb").hide();
    $( "#tabs" ).tabs({
    	//active = $( ".selector" ).tabs( "option", "active" ),
       // event: "mouseover"
      });

    $( document ).tooltip({
    	items: " rect, [title], text, tspan",
    	content: function() {
    		var element = $( this );
            if ( element.is( "[title]" ) ) { //this is a "normal" tooltip returning the title of an element
                return element.attr( "title" );
              }
			//these are element of the concept map, we return the label text:
    	 	 //if(element.is("rect")){    			
    	 		 //return element.attr("userData"); //not working, find a workaround?
    		//}
			/*if(element.is("text")){
    			return element.text;
    		}*/
			if(element.is("tspan")){ 
				var tooltip = getToolTipForRect(element);
				if(tooltip!="") return tooltip;
			}
    	}
        
    });
    $( ".draggable" ).draggable();	
    $( "#list_diagnoses" ).sortable({
 		stop: function( event, ui ) {
 			var sorted = $( "#list_diagnoses" ).sortable( "serialize", { key: "selddx" } );
 			reOrderDiagnoses(sorted, ui.item.attr("id"));
 		}
    });
    $( "#list_diagnoses" ).disableSelection();
    $( "#list_tests" ).sortable({
 		stop: function( event, ui ) {
 			var sorted = $( "#list_tests" ).sortable( "serialize", { key: "selds" } );
 			reOrderTests(sorted, ui.item.attr("id"));
 		}
    });
    $( "#list_tests" ).disableSelection();
    $( "#list_mngs" ).sortable({
 		stop: function( event, ui ) {
 			var sorted = $( "#list_mngs" ).sortable( "serialize", { key: "selmng" } );
 			reOrderMngs(sorted, ui.item.attr("id"));
 		}
    });
    $( "#list_mngs" ).disableSelection();
    $( "#list_problems" ).sortable({
 		stop: function( event, ui ) {
 			var sorted = $( "#list_problems" ).sortable( "serialize", { key: "selProb" } );
 			reOrderProblems(sorted, ui.item.attr("id"));
 		}
    });
    $( "#list_problems" ).disableSelection();
    $( "#confidence_slider" ).slider({
       orientation: "vertical",
    	min: 0,
    	max: 100,
    	step: 1,
    });
	$("#jdialog").dialog({
		autoOpen: false,
		modal: true,
		width: "auto",
		height: "auto"
	});
	
	my_canvas  = new MyCanvas("canvas");
    initConceptMap(); 

	my_canvas.getCommandStack().addEventListener(function(e){
	      if(e.isPostChangeEvent()){
	          //updatePreview();
	  } 
	});
	initAddHyp();
	initAddFind();
	initAddMng();
	initAddTest();
	my_canvas.on("figure:remove", function(emitter, event){
		//alert(emitter.getFigure());
	    //alert("id=" + event.figure.id);
	    //deleteItem(event.figure.id);
	 });

	toggleSubmit();
});


</script>
</head>
<body style="font-family:arial;"><!-- test: #{crtContext.test}-->

 <div id="case_story" style="float:left;width:60%;border:1px;">
Case placed here...<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
<h:form>
   <h:commandLink action="#{navController.openOverview}" value="Overview" >
   	<f:param name="user_id" value="#{crtContext.userId}" />
   </h:commandLink>	
   
</h:form>
</div>

	<div id="tabs" class="cr-tabs">
	  <ul>
	    <li><a href="#tabs-1">#{prop['patient']}</a></li> <!-- example for internationalization -->
	    <li><a href="#tabs-2">#{prop['problems']}</a></li>
	     <li><a href="#tabs-4">Summary</a></li>
	    
	    <li><a href="#tabs-3">DDX</a></li>
	    <li><a href="#tabs-5">Diagn. Steps</a></li>
	    <li><a href="#tabs-6">Therapy</a></li>
	    <li><a href="#tabs-7">Concept map</a></li>
	    <li><a href="#tabs-8">Notes</a></li>
	  </ul>
		  <div id="tabs-1">
		  <div id="patimg" style="position:relative;right:0px; top:0px; float:right;"><img src="patient.png" width="150px" /></div>
		  	<div id="descr">
		  		Name: Henry Rodin<br/>
			  	Age: 30, Gender: M <br/>
				Course of Time: 
				<h:selectOneMenu onchange="javascript:changeCourseOfTime();" class="f_select" id="courseTime" value="#{crtContext.patillscript.courseOfTime}">
				<f:selectItem itemLabel="-" itemValue="-1" />
				<f:selectItem itemLabel="acute" itemValue="1" />
				<f:selectItem itemLabel="chronic" itemValue="2" />
				</h:selectOneMenu>
				<!-- <select class="f_select" id="courseTime"><option value="-1">-</option><option value="1">acute</option><option value="2">chronic</option></select> --> 
			</div>
		  </div>
		  <!-- problems -->
		  <div id="tabs-2" style="background-color:#cccccc;">	
		  			<div class="search"><input class="f_text" id="problems"></input></div>
					<div class="ddx_left">
					<h:form id="probform">
					<h:panelGroup id="problems_group">
					<ol id="list_problems" class="sortable">
					   <ui:repeat id="repeatprob" value="#{crtContext.patillscript.problems}" var="prob" varStatus="status">
					   		<ui:include src="probline.xhtml" />
    					</ui:repeat>
    				</ol>
    				<div id="jsonProbMap" >#{crtContext.patillscript.problemsJson}</div>
    				</h:panelGroup>
    				     <h:commandButton id="hiddenProbButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCMCallback"></f:ajax>
						</h:commandButton></h:form>
				</div>			
		  </div>
		  <div id="tabs-4">	
		  		<textarea class="f_textarea" name="summSt" cols="50" rows="10"></textarea><br/>
		  		<a href="javascript:saveSummSt();" title="Save your summary statement"><i class="icon-floppy"></i></a>
		  </div>
		  <!--  diagnoses -->
		  <div id="tabs-3">			  		
		  			<div class="search"><input class="f_text" id="ddx"></input></div>
		  			<div class="ddx_left">
		  			<h:form id="ddxform">
					<h:panelGroup id="ddx_group">
					<ol id="list_diagnoses" class="sortable">
						<ui:repeat value="#{crtContext.patillscript.diagnoses}" var="ddx" varStatus="status">
							<ui:include src="ddxline.xhtml" />
     					</ui:repeat>					
					</ol>
					<div id="jsonDDXMap" >#{crtContext.patillscript.ddxJson}</div>
    				</h:panelGroup>
    				     <h:commandButton id="hiddenDDXButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCMCallback"></f:ajax>
						</h:commandButton></h:form>
				</div>
				<div id="confidence_slider" class="conf_slider" title="Level of confidence"></div>
		  </div>
		  <!-- tests -->
		  <div id="tabs-5">
		  		<div class="search"><input class="f_text" id="tests"></input></div>
		  			<div class="ddx_left">
		  			<h:form id="testform">
		  			<h:panelGroup id="test_group">
					<ol id="list_tests" class="sortable">
						<ui:repeat value="#{crtContext.patillscript.tests}" var="test" varStatus="status">
							<ui:include src="testline.xhtml" />
     					</ui:repeat>				
						<!-- <li id="selds_1">Chest X-ray <select class="f_select"><option value="-1">scanning</option><option>r/c Pneumonia</option></select></li>-->
					</ol>
					<div id="jsonTestsMap" >#{crtContext.patillscript.testsJson}</div>
    				</h:panelGroup>
    				     <h:commandButton id="hiddenTestsButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCMCallback"></f:ajax>
						</h:commandButton>
					</h:form>
					</div>
		  	</div>
		  <!-- managements -->
		  <div id="tabs-6">
		  	<div class="search"><input class="f_text" id="mng"></input></div>
		  	<div class="ddx_left">
	  			<h:form id="mngform">
	  			<h:panelGroup id="mng_group">
	
				<ol id="list_mngs" class="sortable">
					<ui:repeat value="#{crtContext.patillscript.mngs}" var="mng" varStatus="status">
						<ui:include src="mngline.xhtml" />
	   					</ui:repeat>				
					<!-- <li id="selds_1">Chest X-ray <select class="f_select"><option value="-1">scanning</option><option>r/c Pneumonia</option></select></li>-->
				</ol>
				<div id="jsonTestsMap" >#{crtContext.patillscript.mngsJson}</div>
	  				</h:panelGroup>
	  				     <h:commandButton id="hiddenMngButton" value="RenderSomething" style="visibility:hidden">
	  						<f:ajax render="@form" onevent="updateCMCallback"></f:ajax>
					</h:commandButton></h:form>
				</div>
	  		</div>
		  
		  <!-- concept map -->
		   <div id="tabs-7">
				<div id="canvas" class="canvas"> </div>
				 	<div class="newElemContainer">
				 		<span id="findcontainer"></span><div id="addfind" class=" newElem newFind">Problem</div><br/>
						<span id="hypcontainer"></span><div id="addhyp" class=" newElem newHyp">Diagnosis</div><br/>
			   			<span id="dscontainer"></span> <div id="adddtest" class=" newElem newDiagnStep">Diagn. Step</div><br/>
			    		<span id="mngcontainer"></span> <div id="addmng" class=" newElem  newMng">Managment</div> 
			   		 </div>
		  		 </div>
		     <div id="tabs-8">	
		  		<textarea class="f_textarea" name="notes" cols="50" rows="10"></textarea>
		  </div>
		    <div id="trashbindiv" class="trashbindiv"><!-- <i class="icon-trash-1"></i>--><div class="msg" id="msg"></div>
		    
		    	
		    	<!-- <ui:repeat value="#{crtContext.messages}" var="msg" varStatus="status">
		    		#{msg.summary},  #{msg.detail}
	       		</ui:repeat>-->
		    </div>
			  	<div class="navfooter"><!-- <a href="" title="take notes"><i class="icon-edit"></i></a>-->
			  	<i class="icon-help-circled" title="not yet working"></i>
			  	<a href="javascript:getProblemFedback();" title="See an experts' problems"><i class="icon-user-md"></i></a> 
				<a href="javascript:getProblemPeerFedback();" title="See problems listed by your peers"><i class="icon-users"></i></a>
				<a href="javascript:doSubmitDDX();" title="Submit your final diagnoses and differentials"><i id="uploadddx" class="icon-upload-off"></i></a>
				<a href="javascript:doDisplayIS();" title="open illness script"><i id="is_icon" class="icon-list-alt"></i></a></div>
		  	<!--  </div>-->
		  	<!--  <div class="cm-preview"><a href="javascript:openCanvas();" title="click to open concept map"><img id="preview_img" style="border-radius:5px;overflow:auto; width:50px; height:50px;"/> </a></div> -->
		 <!--   </div>-->
	</div>   
	
	<!-- 
	open questions/issues: 
		- do we want to keep lists and CP in sync all the time or leave it up to the user and ask if deleting in list or cm?
		- tabs or accordion display?
		- how to implement the notes? 
		- CM preview needed? 
		- display of rect/label not correct
		- connection labels just on contextmenu?
	 --> 

<!-- <a href="portfolio.xhtml">Overview</a>-->
<div id="jdialog">Are you sure you want to submit Pneumonia as your final diagnosis without any further work-up?<br/>
<a href="javascript:submitDDXConfirmed();">Yes</a><br/></div>
<div id="dialogCMProb" class="listdialog" ><input id="cm_prob_sel" class="f_text"></input></div>
<div id="dialogCMDDX" class="listdialog"><input id="cm_ddx_sel" class="f_text"></input></div>
<div id="dialogCMMng" class="listdialog"><input id="cm_mng_sel" class="f_text"></input></div>
<div id="dialogCMTest" class="listdialog"><input id="cm_ds_sel" class="f_text"></input></div>

</body>
</html>