<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"   
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      >
<!-- <html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"      
      xmlns:h="http://java.sun.com/jsf/html">-->
<head>

<title>Patient Illness Script</title>
 <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

<link rel="stylesheet" type="text/css" href="../scripts/jquery112/ui-lightness/jquery-ui.css" /> 
<link rel="stylesheet" type="text/css" href="../scripts/draw2d/css/contextmenu.css"  />
<!--  <link rel="stylesheet" type="text/css" href="<PMW fcache>files/html/scripts/draw2d/css/contextmenu.css"  />-->
<link rel="stylesheet" href="../styles/clinreason.css" />

<script type="text/javascript" src="../scripts/jquery112/jquery.js"></script>
<script type="text/javascript" src="../scripts/jquery112/jquery-ui.min.js"></script>
<script type="text/javascript" src="../scripts/jquery112/jquery-ui.js"></script>
<script src="../scripts/draw2d/lib/shifty.js"></script>	
<script src="../scripts/draw2d/lib/raphael.js"></script>			
<script src="../scripts/draw2d/lib/jquery.autoresize.js"></script>	
<script src="../scripts/draw2d/lib/jquery-touch_punch.js"></script>	
<script src="../scripts/draw2d/lib/jquery.contextmenu.js"></script>	
<script src="../scripts/draw2d/lib/rgbcolor.js"></script>	
<script src="../scripts/draw2d/lib/canvg.js"></script>	
<script src="../scripts/draw2d/lib/Class.js"></script>	
<script src="../scripts/draw2d/lib/json2.js"></script>	
<script src="../scripts/draw2d/lib/pathfinding-browser.min.js"></script>
<script src="../scripts/draw2d/src/draw2d.js"></script>	
<script src="../scripts/mydraw2d/LabelConnection.js"></script>	
<script src="../scripts/mydraw2d/LabelRectangle.js"></script>	
<script src="../scripts/mydraw2d/DDXRectangle.js"></script>	
<script src="../scripts/mydraw2d/MyLabel.js"></script>	
<script src="../scripts/mydraw2d/MyCanvas.js"></script>	
<script src="../scripts/draw2d/lib/jquery.browser.js"></script>
<script src="../scripts/draw2d/lib/jquery.layout.js"></script>
<script src="../scripts/mydraw2d.js"></script>
<script src="../scripts/crt.js"></script>
<script src="../scripts/ajax.js"></script>
<script src="../scripts/js.cookie.js"></script>
<script language="JavaScript">


var msg2="Please connect the hypotheses with the findings";
var sessId = "#{crtContext.patillscript.sessionId}";
var scriptId = "#{crtContext.patillscript.id}";
var listUrl="jsonp_en.json";
var lang = "#{crtContext.patillscript.locale}";
var my_canvas = null;
var currentStage = $.getUrlVar('stage');
var expFeedback = false; //default is that expert feedback is off
var peerFeedback = false; //default is that expert feedback is off
var active;
var minLengthTypeAhead = 4;
//var errorNum = "#{crtContext.patillscript.errorNum}";
var submitted = "#{crtContext.patillscript.submitted}";
/*draw2d.Configuration.factory.createConnection=function(sourcePort, targetPort, callback, dropTarget){
	 addConnection(sourcePort, targetPort);
	 return new LabelConnection();
 };*/
 

$(function() {
	//Cookies.remove('tab'); -> activate for cookit tab setting testing....
	if(lang=="de") listUrl = "jsonp_de.json";
	$("#dialogCMDDX").hide();
	$("#dialogCMProb").hide();
	$("#dialogCMTest").hide();
	$("#dialogCMMng").hide();
	$("#dialogCMEpi").hide();
	$("#jdialogError").hide();
	
	var tabs = $( "#tabs" ).tabs();
      
	$( ".cr-tabs" ).tabs({
		  active: getCurrentTab() //we get the last open tab from the cookie
		});
	
	$( "#tabs" ).tabs({ //activate to allow activating tabs via mouseover
       // event: "mouseover"
      });

	//toggleExpertFeedbackOnLoad();
    $( document ).tooltip({
    	items: " rect, [title], text, tspan",
    	content: function() {
    		var element = $( this );
            if ( element.is( "[title]" ) ) { //this is a "normal" tooltip returning the title of an element
                return element.attr( "title" );
              }
			//these are element of the concept map, we return the label text:
    	 	 //if(element.is("rect")){    			
    	 		 //return element.attr("userData"); //not working, find a workaround?
    		//}
			/*if(element.is("text")){
    			return element.text;
    		}*/
			if(element.is("tspan")){ 
				var tooltip = getToolTipForRect(element);
				if(tooltip!="") return tooltip;
			}
    	}
        
    });
    //$( ".draggable" ).draggable();	
	initLists();
    $( "#confidence_slider" ).slider({
       orientation: "vertical",
    	min: 0,
    	max: 100,
    	step: 1,
    });
	$("#jdialog").dialog({
		autoOpen: false,
		modal: true,
		width: "auto",
		height: "auto"
	});
	$("#jdialogError").dialog({
		autoOpen: false,
		modal: true,
		width: "auto",
		height: "auto"
	});
	
	my_canvas  = new MyCanvas("canvas");
    initConceptMap(); 
    my_canvas.installEditPolicy(new draw2d.policy.connection.DragConnectionCreatePolicy({
        createConnection: function(){
        	
        	//alert(this.getSource());
        //	addConnection(sourcePort, targetPort);
            return new LabelConnection();
        }
	/*my_canvas.getCommandStack().addEventListener(function(e){
	      if(e.isPostChangeEvent()){
	          //updatePreview();
	  } */
	}));
	
	initAddHyp();
	initAddFind();
	initAddMng();
	initAddTest();
	initAddEpi();

	/*my_canvas.on("figure:remove", function(emitter, event){
		//alert(emitter.getFigure());
	    //alert("id=" + event.figure.id);
	    //deleteItem(event.figure.id);
	 });*/
	 my_canvas.on("figure:add", function(emitter, event){
		 addMyConnection(event.figure);
		 });


	toggleSubmit();
});


</script>
</head>
<body style="font-family:arial;"><!-- test: #{crtContext.test}-->

<!--   <div id="case_story" style="float:left;width:60%;border:1px;">
Case placed here...<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>

</div>-->

	<div id="tabs" class="cr-tabs">
	  <ul>
	    <li><a href="#tabs-0"  onclick="switchTab(0);">#{prop['patient']}</a></li> <!-- example for internationalization -->
	    <li><a href="#tabs-1" onclick="switchTab(1);">Problems</a></li>
	    <!--  <li><a href="#tabs-2" onclick="switchTab(2);">Summary</a></li>-->
	    
	    <li><a href="#tabs-2" onclick="switchTab(2);">DDX</a></li>
	    <li><a href="#tabs-3" onclick="switchTab(3);">Diagn. Steps</a></li>
	    <li><a href="#tabs-4" onclick="switchTab(4);">Therapy</a></li>
	    <li><a href="#tabs-5" onclick="switchTab(5);">Map</a></li>
	   <!--  <li><a href="#tabs-7" onclick="switchTab(7);">Notes</a></li>-->
	  </ul>
		  <div id="tabs-0">
		  <div id="patimg" style="position:relative;right:0px; top:0px; float:right;"><img src="patient.png" width="100px" /><br/>Delai Johnston</div>
		  	<div id="descr">
		  		<!--Name: Delai Johnston<br/>
			  	  Age: 65, Gender: M <br/>-->
				Course of Time: 
				<h:selectOneMenu onchange="javascript:changeCourseOfTime();" class="f_select" id="courseTime" value="#{crtContext.patillscript.courseOfTime}">
				<f:selectItem itemLabel="-" itemValue="-1" />
				<f:selectItem itemLabel="acute" itemValue="1" />
				<f:selectItem itemLabel="chronic" itemValue="2" />
				</h:selectOneMenu><br/><br/>
				Summary Statement<br/>
				<textarea class="f_textarea" name="summSt" id="summStText" cols="40" rows="7">#{crtContext.patillscript.summSt.text}</textarea><br/>
		  		<a href="javascript:saveSummSt('#{crtContext.patillscript.summStId}');" title="Save your summary statement"><i class="icon-floppy"></i></a>
				
				<!--  Exposures/Epi: <input class="f_text" id="epi"></input>
				<div class="ddx_left">
				<h:form id="epiform">
					<h:panelGroup id="epi_group">
					<ol id="list_epi" class="sortable">
					   <ui:repeat id="repeatepi" value="#{crtContext.patillscript.epis}" var="epi" varStatus="status">
					   		<ui:include src="epiline.xhtml" />
    					</ui:repeat>
    				</ol>
    				</h:panelGroup>
    				     <h:commandButton id="hiddenEpiButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCallback"></f:ajax>
						</h:commandButton></h:form>
				</div>-->
			</div>
		  </div>
		  <!-- problems -->
		  <div id="tabs-1" >	<!--  style="background-color:#cccccc;"-->
		  			<div class="search"><input class="f_text" id="problems" title="Please add any problems, findings, exposures, or risk factors."></input></div>
					<div class="ddx_left">
					<h:form id="probform">
					<h:panelGroup id="problems_group">
					<ol id="list_problems" class="sortable">
					   <ui:repeat id="repeatprob" value="#{crtContext.patillscript.problems}" var="prob" varStatus="status">
					   		<ui:include src="probline.xhtml" />
    					</ui:repeat>
    				</ol>
    				<!-- <div id="jsonProbMap">#{crtContext.patillscript.problemsJson}</div>-->
    				</h:panelGroup>
    				     <h:commandButton id="hiddenProbButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCallback"></f:ajax>
						</h:commandButton></h:form>
				</div>			
		  </div>
		 <!-- <div id="tabs-2">	
		  		<textarea class="f_textarea" name="summSt" id="summStText" cols="50" rows="10">#{crtContext.patillscript.summSt.text}</textarea><br/>
		  		<a href="javascript:saveSummSt('#{crtContext.patillscript.summStId}');" title="Save your summary statement"><i class="icon-floppy"></i></a>
		  </div>-->
		  <!--  diagnoses -->
		  <div id="tabs-2">			  		
		  			<div class="search"><input class="f_text" id="ddx" title="Please add your differentials"></input></div>
		  			<div class="ddx_left">
		  			<h:form id="ddxform">
					<h:panelGroup id="ddx_group">
					<ol id="list_diagnoses" class="sortable">
						<ui:repeat value="#{crtContext.patillscript.diagnoses}" var="ddx" varStatus="status">
							<ui:include src="ddxline.xhtml" />
     					</ui:repeat>					
					</ol>
					<!-- <div id="jsonDDXMap" style="visibility:hidden" >#{crtContext.patillscript.ddxJson}</div>-->
    				</h:panelGroup>
    				     <h:commandButton id="hiddenDDXButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCallback"></f:ajax>
						</h:commandButton></h:form>
				</div>
				<div id="confidence_slider" class="conf_slider" title="Please indicate how confident you are with your current differentials."></div>
		  </div>
		  <!-- tests -->
		  <div id="tabs-3">
		  		<div class="search"><input class="f_text" id="tests" title="Please add any tests or examinations you want to order or perform."></input></div>
		  			<div class="ddx_left">
		  			<h:form id="testform">
		  			<h:panelGroup id="test_group">
					<ol id="list_tests" class="sortable">
						<ui:repeat value="#{crtContext.patillscript.tests}" var="test" varStatus="status">
							<ui:include src="testline.xhtml" />
     					</ui:repeat>				
						<!-- <li id="selds_1">Chest X-ray <select class="f_select"><option value="-1">scanning</option><option>r/c Pneumonia</option></select></li>-->
					</ol>
					<!--  <div id="jsonTestsMap" style="visibility:hidden">#{crtContext.patillscript.testsJson}</div>-->
    				</h:panelGroup>
    				     <h:commandButton id="hiddenTestButton" value="RenderSomething" style="visibility:hidden">
    						<f:ajax render="@form" onevent="updateCallback"></f:ajax>
						</h:commandButton>
					</h:form>
					</div>
		  	</div>
		  <!-- managements -->
		  <div id="tabs-4">
		  	<div class="search"><input class="f_text" id="mng" title="Please add any management decisions for your patient."></input></div>
		  	<div class="ddx_left">
	  			<h:form id="mngform">
	  			<h:panelGroup id="mng_group">
	
				<ol id="list_mngs" class="sortable">
					<ui:repeat value="#{crtContext.patillscript.mngs}" var="mng" varStatus="status">
						<ui:include src="mngline.xhtml" />
	   					</ui:repeat>				
					<!-- <li id="selds_1">Chest X-ray <select class="f_select"><option value="-1">scanning</option><option>r/c Pneumonia</option></select></li>-->
				</ol>
				<!--  <div id="jsonTestsMap" style="visibility:hidden">#{crtContext.patillscript.mngsJson}</div>-->
	  				</h:panelGroup>
	  				     <h:commandButton id="hiddenMngButton" value="RenderSomething" style="visibility:hidden">
	  						<f:ajax render="@form" onevent="updateCallback"></f:ajax>
					</h:commandButton></h:form>
				</div>
	  		</div>
		  
		  <!-- concept map -->
		   <div id="tabs-5">
				<div id="canvas" class="canvas"> </div>
				 	<div class="newElemContainer">
				 		<span id="findcontainer"></span><div id="addfind" class=" newElem newFind">Problem</div><br/>
						<span id="hypcontainer"></span><div id="addhyp" class=" newElem newHyp">Diagnosis</div><br/>
			   			<span id="dscontainer"></span> <div id="adddtest" class=" newElem newDiagnStep">Diagn. Step</div><br/>
			    		<span id="mngcontainer"></span> <div id="addmng" class=" newElem  newMng">Managment</div> 
			    		<!--<span id="epicontainer"></span> <div id="addepi" class=" newElem  newEpi">Epi</div> -->
			    		
			   		 </div>
		  		 </div>
		     <!-- <div id="tabs-7">	
		  		<textarea class="f_textarea" name="notes" id="notes" cols="50" rows="10">#{crtContext.patillscript.note.text}</textarea><br/>
		  		<a href="javascript:saveNote('#{crtContext.patillscript.noteId}');" title="Save your notes"><i class="icon-floppy"></i></a>
		  		
		  </div>-->
		    <div id="trashbindiv" class="trashbindiv"><!-- <i class="icon-trash-1"></i>--><div class="msg" id="msg"></div>
		    
		    	
		    	<!-- <ui:repeat value="#{crtContext.messages}" var="msg" varStatus="status">
		    		#{msg.summary},  #{msg.detail}
	       		</ui:repeat>-->
		    </div>
			  	<div class="navfooter"><h:form id="ddxsubmitform"><!-- <a href="" title="take notes"><i class="icon-edit"></i></a>-->
			  	<i class="icon-help-circled" title="not yet working"></i>
			  	<a href="javascript:toggleExpertFedback();" title="See the author's suggestions"><i id="expFeedbackButton" class="icon-user-md"></i></a> 
				<a href="javascript:tooglePeerFedback();" title="See peer responses"><i  class="icon-users"></i></a>

	<h:panelGroup id="ddxubmitPG">
		<a href="javascript:openErrorDialog();" title="Potential Errors (#{crtContext.patillscript.errorNum})"><i class="icon-attention-circled"></i></a>		
    </h:panelGroup>
    	  <h:commandLink id="hiddenDDXSubmitButton" action="#{crtContext.patillscript.submitDDX}" value="" style="visibility:collapse" >
		</h:commandLink>			
				
				<a id="submitDDXHref" href="javascript:doSubmitDDX();" title="Submit your final diagnoses"><i id="uploadddx" class="icon-upload-off"></i></a>
				<a href="javascript:doDisplayIS();" title="open illness script"><i id="is_icon" class="icon-list-alt"></i></a>
		  	</h:form>	</div>

	</div> <br clear="all"/>  
	<h:form id="graphform">
		<h:panelGroup id="graph">
			<div id="jsonGraph" style="display:none;">#{crtContext.graph.toJson}</div>
			<div id="jsonConns" style="display:none;">#{crtContext.graph.jsonConns}</div> <!-- c onnections for concept map -->
			<!--<div id="jsonDDXs">#{crtContext.graph.jsonDDXConns}</div>-->
			<!--  <div id="jsonGraphExp" >#{crtContext.graph.toJsonExp}</div>
			<div id="jsonConnsExp">#{crtContext.graph.jsonConnsExp}</div>--> <!-- c onnections for concept map -->
			
		</h:panelGroup>
		     <h:commandButton id="hiddenGraphButton" value="RenderSomething" style="visibility:hidden">
				<f:ajax render="@form" onevent="updateCMCallback"></f:ajax>
			</h:commandButton>
	</h:form>

<div id="jdialog">Are you sure you want to submit your final diagnosis/-es?<br/>
<a href="javascript:submitDDXConfirmed();">Yes</a><br/></div>
<div id="jdialogError">				
	<ul id="errors">
		<ui:repeat value="#{crtContext.patillscript.errors}" var="err" varStatus="status">
			<ui:include src="errorline.xhtml" />
 		</ui:repeat>				
	</ul>More information ....</div>
<div id="dialogCMProb" class="listdialog" ><input id="cm_prob_sel" class="f_text"></input></div>
<div id="dialogCMDDX" class="listdialog"><input id="cm_ddx_sel" class="f_text"></input></div>
<div id="dialogCMMng" class="listdialog"><input id="cm_mng_sel" class="f_text"></input></div>
<div id="dialogCMTest" class="listdialog"><input id="cm_ds_sel" class="f_text"></input></div>
<div id="dialogCMEpi" class="listdialog"><input id="cm_epi_sel" class="f_text"></input></div>

</body>
</html>